```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteMaster ONE | Ultimate Waste Collection Router</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--accent:#0078ff;--dark:#1a1a1a;--bg:#f4f4f9;--text:#333;--white:#ffffff}
        body,html{margin:0;padding:0;height:100%;width:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;overflow:hidden;display:flex;flex-direction:column;background:var(--bg)}
        header{background:var(--dark);color:var(--white);padding:.5rem 1rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.2);z-index:1001}
        .logo{font-weight:800;font-size:1.2rem;letter-spacing:-1px}
        .logo span{color:var(--accent)}
        #stats-ribbon{background:#fff;border-bottom:1px solid #ddd;padding:5px 15px;display:flex;gap:20px;font-size:.85rem;color:#666;overflow-x:auto;white-space:nowrap}
        .stat-val{color:var(--dark);font-weight:bold}
        #main-container{flex:1;display:flex;flex-direction:column;position:relative}
        #map{height:60vh;width:100%;background:#e0e0e0}
        #controls{padding:10px;background:var(--white);border-top:1px solid #ccc;display:flex;align-items:center;gap:8px;flex-wrap:wrap;box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:1000}
        .btn{background:#eee;border:1px solid #ccc;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:5px;transition:all .2s;color:var(--text)}
        .btn:hover{background:#e0e0e0}
        .btn.primary{background:var(--accent);color:white;border-color:var(--accent)}
        .btn.primary:disabled{background:#ccc;border-color:#ccc;cursor:not-allowed}
        .btn-reset{color:#d93025}
        input[type=file]{display:none}
        #console-footer{background:#222;color:#0f0;font-family:'Courier New',Courier,monospace;font-size:.75rem;padding:4px 10px;height:24px;display:flex;align-items:center}
        #settings-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;z-index:2000;justify-content:center;align-items:center}
        .drawer{background:white;padding:20px;border-radius:8px;width:320px;box-shadow:0 10px 25px rgba(0,0,0,.2)}
        .drawer h3{margin-top:0}
        .setting-row{margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
        .toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:var(--dark);color:white;padding:8px 16px;border-radius:20px;font-size:.9rem;display:none;z-index:3000;white-space:nowrap}
    </style>
</head>
<body>
<header>
    <div class="logo">RouteMaster <span>ONE</span></div>
    <div style="font-size:.7rem;opacity:.7">v1.4 CORE ENGINE</div>
</header>
<div id="stats-ribbon">
    <span>Ways: <span class="stat-val" id="stat-ways">0</span></span>
    <span>Nodes: <span class="stat-val" id="stat-nodes">0</span></span>
    <span>Total Length: <span class="stat-val" id="stat-dist">0.0 km</span></span>
    <span>Dead-heads: <span class="stat-val" id="stat-dead">0.0 km</span></span>
    <span>U-Turns: <span class="stat-val" id="stat-uturns">0</span></span>
</div>
<div id="main-container">
    <div id="map"></div>
    <div id="controls">
        <label class="btn" title="Load OpenStreetMap Data">üìÅ Load OSM<input type="file" id="osm-input" accept=".osm,.xml"></label>
        <label class="btn" title="Attach External GPX Constraints">üìé Attach GPX<input type="file" id="gpx-input" accept=".gpx"></label>
        <button class="btn" id="btn-settings" title="Engine Settings">‚öôÔ∏è</button>
        <div style="flex-grow:1"></div>
        <button class="btn" id="btn-export-app" title="Download standalone bundle">‚¨áÔ∏è Export App</button>
        <button class="btn primary" id="btn-download-gpx" disabled>‚Üì Download GPX</button>
        <button class="btn btn-reset" id="btn-reset">üîÑ Reset</button>
    </div>
</div>
<div id="console-footer">Turbo Engine Ready.</div>
<div id="settings-overlay">
    <div class="drawer">
        <h3>Routing Settings</h3>
        <div class="setting-row"><label>Respect Oneways</label><input type="checkbox" id="set-oneways" checked></div>
        <div class="setting-row"><label>Minimise U-turns</label><input type="checkbox" id="set-uturns" checked></div>
        <div class="setting-row">
            <label>Max Dead-head (m)</label>
            <input type="range" id="set-deadhead" min="0" max="200" value="50">
            <span id="deadhead-val" style="width:40px;text-align:right">50m</span>
        </div>
        <div class="setting-row" id="gpx-mode-container" style="display:none;border-top:1px solid #eee;padding-top:10px;flex-direction:column;align-items:start">
            <label style="font-weight:bold;margin-bottom:5px">GPX Overlay Mode</label>
            <select id="gpx-mode" style="width:100%;padding:4px">
                <option value="barrier">Barrier (Cut OSM)</option>
                <option value="extra">Extra Coverage (Force traverse)</option>
            </select>
        </div>
        <button class="btn" style="width:100%;margin-top:10px" onclick="document.getElementById('settings-overlay').style.display='none'">Close</button>
    </div>
</div>
<div class="toast" id="toast">Message here</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* ---------- RouteMaster ONE  ‚Äì  drop-in optimised core  ---------- */
const CONFIG={accent:'#0078ff',deadHeadColor:'#a855f7',wayColor:'#64748b',circuitColor:'#0078ff',maxDijkstraDist:500,uTurnThreshold:135};
let map,graph,circuit=[],circuitLayer=null,nodesLookup=new Map(),ways=[],startId=null,lastBuild=0;

/* ---- init ---- */
window.addEventListener('DOMContentLoaded',()=>{
    map=L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
    log('Turbo Engine Ready.');
});
const consoleEl=document.getElementById('console-footer');
function log(msg){consoleEl.innerText=msg;}
function toast(msg){const t=document.getElementById('toast');t.innerText=msg;t.style.display='block';setTimeout(()=>t.style.display='none',4000);}
function haversine(a,b){const R=6371e3,t=Math.PI/180,œÜ1=a[0]*t,œÜ2=b[0]*t,ŒîœÜ=(b[0]-a[0])*t,ŒîŒª=(b[1]-a[1])*t,x=Math.sin(ŒîœÜ/2),y=Math.sin(ŒîŒª/2),aa=x*x+Math.cos(œÜ1)*Math.cos(œÜ2)*y*y;return 2*R*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));}
function bearing(a,b){const t=Math.PI/180,œÜ1=a[0]*t,œÜ2=b[0]*t,Œª1=a[1]*t,Œª2=b[1]*t,y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2),x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);return Math.atan2(y,x)*180/Math.PI;}

class FastGraph{
    constructor(){this.adj=new Map();this.degI=new Uint32Array(1<<20);this.degO=new Uint32Array(1<<20);this.idx=new Map();this.rev=[];this.edgeCnt=0;}
    addEdge(u,v,d,wayId,isDH=false){if(!this.idx.has(u)){this.idx.set(u,this.rev.length);this.rev.push(u);}if(!this.idx.has(v)){this.idx.set(v,this.rev.length);this.rev.push(v);}const ui=this.idx.get(u),vi=this.idx.get(v);if(!this.adj.has(ui))this.adj.set(ui,[]);this.adj.get(ui).push({to:vi,dist:d,wayId,isDeadHead:isDH,used:false});this.degO[ui]++;this.degI[vi]++;this.edgeCnt++;}
    compactDegrees(){this.degI.fill(0);this.degO.fill(0);this.edgeCnt=0;this.adj.forEach((arr,u)=>{this.degO[u]=arr.length;arr.forEach(e=>{this.degI[e.to]++;this.edgeCnt++;});});}
    getUnbalanced(){const src=[],snk=[];for(let i=0;i<this.rev.length;i++){const d=this.degO[i]-this.degI[i];if(d>0)for(let k=0;k<d;k++)snk.push(i);if(d<0)for(let k=0;k<-d;k++)src.push(i);}return{sources:src,sinks:snk};}
}

function needsFullRebuild(){return performance.now()-lastBuild>60*60*1000;}
function buildOrUpdate(){
    const t0=performance.now(),respect=document.getElementById('set-oneways').checked,minUTurn=document.getElementById('set-uturns').checked,maxDead=+document.getElementById('set-deadhead').value;
    if(!graph||needsFullRebuild()){
        graph=new FastGraph();
        ways.forEach(w=>{for(let i=0;i<w.nodes.length-1;i++){const u=w.nodes[i],v=w.nodes[i+1],cu=nodesLookup.get(u),cv=nodesLookup.get(v);if(!cu||!cv)continue;const d=haversine(cu,cv);graph.addEdge(u,v,d,w.id);if(!w.oneway)graph.addEdge(v,u,d,w.id);}});
        lastBuild=performance.now();startId=graph.rev[0];
    }
    balanceGraph(maxDead,minUTurn);findEulerianCircuit();updateStats(performance.now()-t0);
}
function balanceGraph(maxDead,minUTurn){
    graph.compactDegrees();let{sources,sinks}=graph.getUnbalanced();if(!sources.length)return;
    const fwd=new Map();graph.adj.forEach((arr,u)=>{arr.forEach(e=>{if(!fwd.has(u))fwd.set(u,[]);fwd.get(u).push([e.to,e.dist]);});});
    class PQ{constructor(){this.h=[];}push(k,v){this.h.push([k,v]);this.h.sort((a,b)=>a[0]-b[0]);}pop(){return this.h.shift();}get len(){return this.h.length;}}
    const deadEdges=[],used=new Uint8Array(graph.rev.length);sources.sort(()=>Math.random()-.5);
    for(const s of sources){
        const dist=new Float32Array(graph.rev.length).fill(Infinity),prev=new Int32Array(graph.rev.length).fill(-1),pq=new PQ();pq.push(0,s);dist[s]=0;
        while(pq.len){const[d,u]=pq.pop();if(d>dist[u])continue;if(used[u]&&sinks.includes(u))break;const edges=fwd.get(u);if(!edges)continue;for(const[v,c]of edges){const nd=d+c;if(nd<dist[v]){dist[v]=nd;prev[v]=u;pq.push(nd,v);}}}
        let bestSink=-1,bestD=Infinity,bestHeading=0;
        for(const t of sinks){if(used[t])continue;const d=dist[t];if(d>maxDead||d>bestD)continue;let headingScore=1;if(minUTurn){const pS=nodesLookup.get(graph.rev[s]),pT=nodesLookup.get(graph.rev[t]),h0=bearing(pS,pT);const arr=graph.adj.get(prev[t]);if(arr&&arr.length){const e=arr.find(x=>x.to===t);if(e){const pP=nodesLookup.get(graph.rev[prev[t]]),h1=bearing(pP,pT);let diff=Math.abs(h0-h1);if(diff>180)diff=360-diff;headingScore=diff;}}}
            if(d<bestD||(d===bestD&&headingScore>bestHeading)){bestD=d;bestSink=t;bestHeading=headingScore;}
        }
        if(bestSink===-1)continue;
        graph.addEdge(graph.rev[s],graph.rev[bestSink],bestD,'deadhead',true);used[bestSink]=1;
    }
}
function findEulerianCircuit(){
    if(!graph||graph.edgeCnt===0)return;
    const adj=graph.adj,circuitStack=[],path=[];let curr=graph.idx.get(startId)||0;circuitStack.push(curr);
    const nextEdge=u=>{const es=adj.get(u);if(!es)return null;for(let i=0;i<es.length;i++)if(!es[i].used){es[i].used=true;return es[i];}return null;};
    while(circuitStack.length){const e=nextEdge(curr);if(e){circuitStack.push(curr=e.to);}else{path.push(curr);curr=circuitStack.pop();}}
    path.reverse();circuit=path.map(i=>graph.rev[i]);renderCircuit();
}
function renderCircuit(){if(circuitLayer){map.removeLayer(circuitLayer);circuitLayer=null;}const latlngs=circuit.map(i=>nodesLookup.get(i)).filter(x=>x);if(latlngs.length<2)return;circuitLayer=L.polyline(latlngs,{color:CONFIG.circuitColor,weight:6,opacity:.8,interactive:false}).addTo(map);map.fitBounds(circuitLayer.getBounds(),{padding:[20,20]});}
function updateStats(ms){let ways=0,dist=0,dead=0;graph.adj.forEach(es=>es.forEach(e=>{if(e.isDeadHead)dead+=e.dist;else{dist+=e.dist;ways++;}}));document.getElementById('stat-ways').textContent=ways;document.getElementById('stat-nodes').textContent=nodesLookup.size;document.getElementById('stat-dist').textContent=(dist/1000).toFixed(2)+' km';document.getElementById('stat-dead').textContent=(dead/1000).toFixed(2)+' km';document.getElementById('stat-uturns').textContent=countUTurns();document.getElementById('btn-download-gpx').disabled=false;log(`Turbo Engine: ${ms.toFixed(0)} ms`);}
function countUTurns(){let c=0;for(let i=1;i<circuit.length-1;i++){const a=nodesLookup.get(circuit[i-1]),b=nodesLookup.get(circuit[i]),c_=nodesLookup.get(circuit[i+1]);if(!a||!b||!c_)continue;let diff=Math.abs(bearing(a,b)-bearing(b,c_));if(diff>180)diff=360-diff;if(diff>CONFIG.uTurnThreshold)c++;}return c;}

document.getElementById('osm-input').onchange=async e=>{const file=e.target.files[0];if(!file)return;try{log('Parsing OSM‚Ä¶');const txt=await file.text(),doc=new DOMParser().parseFromString(txt,'application/xml');nodesLookup.clear();ways=[];doc.querySelectorAll('node').forEach(n=>nodesLookup.set(n.id,[+n.getAttribute('lat'),+n.getAttribute('lon')]));const respect=document.getElementById('set-oneways').checked;doc.querySelectorAll('way').forEach(w=>{const tags={},wayNodes=[];w.querySelectorAll('tag').forEach(t=>tags[t.getAttribute('k')]=t.getAttribute('v'));if(!tags.highway||tags.service==='driveway')return;if(!['residential','tertiary','unclassified','service'].includes(tags.highway))return;w.querySelectorAll('nd').forEach(nd=>wayNodes.push(nd.getAttribute('ref')));ways.push({id:w.getAttribute('id'),nodes:wayNodes,oneway:tags.oneway==='yes'&&respect});});lastBuild=0;buildOrUpdate();}catch(err){log('Error loading OSM.');toast('Failed to parse OSM file.');}};
document.getElementById('gpx-input').onchange=e=>{if(!e.target.files[0])return;document.getElementById('gpx-mode-container').style.display='flex';toast('GPX Attached. Adjust mode in settings.');log('GPX Loaded.');};
document.getElementById('btn-download-gpx').onclick=()=>{if(!circuit.length)return;let gpx='<?xml version="1.0"?><gpx version="1.1" creator="RouteMaster ONE"><trk><name>Collection Route</name><trkseg>';circuit.forEach(id=>{const c=nodesLookup.get(id);if(c)gpx+=`\n<trkpt lat="${c[0]}" lon="${c[1]}"></trkpt>`;});gpx+='\n</trkseg></trk></gpx>';const a=document.createElement('a'),blob=new Blob([gpx],{type:'application/gpx+xml'});a.href=URL.createObjectURL(blob);a.download='route.gpx';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000);};
document.getElementById('btn-reset').onclick=()=>location.reload();
document.getElementById('btn-settings').onclick=()=>document.getElementById('settings-overlay').style.display='flex';
document.getElementById('set-deadhead').oninput=e=>document.getElementById('deadhead-val').innerText=e.target.value+'m';
document.getElementById('btn-export-app').onclick=async()=>{try{const zip=new JSZip();zip.file('index.html',document.documentElement.outerHTML);zip.file('README.txt','RouteMaster ONE ‚Äì Professional Waste Routing\n\n1. Open index.html\n2. Load OSM\n3. Export GPX\n\nMIT Licence.');const blob=await zip.generateAsync({type:'blob'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='RouteMasterONE_portable.zip';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000);}catch(err){toast('Export failed.');}};
</script>
</body>
</html>
```
